import B,{Fragment as pe,createContext as $,createRef as K,useCallback as A,useContext as q,useMemo as D,useReducer as se,useRef as L}from"react";import{useDisposables as ne}from"../../hooks/use-disposables.js";import{useId as N}from"../../hooks/use-id.js";import{useIsoMorphicEffect as I}from"../../hooks/use-iso-morphic-effect.js";import{useComputed as X}from"../../hooks/use-computed.js";import{useSyncRefs as j}from"../../hooks/use-sync-refs.js";import{Features as re,forwardRefWithAs as k,render as V,compact as be}from"../../utils/render.js";import{match as E}from"../../utils/match.js";import{disposables as J}from"../../utils/disposables.js";import{Keys as P}from"../keyboard.js";import{Focus as C,calculateActiveIndex as de}from"../../utils/calculate-active-index.js";import{isDisabledReactIssue7711 as ce}from"../../utils/bugs.js";import{useOutsideClick as fe}from"../../hooks/use-outside-click.js";import{useOpenClosed as me,State as z,OpenClosedProvider as xe}from"../../internal/open-closed.js";import{useResolveButtonType as Te}from"../../hooks/use-resolve-button-type.js";import{useLatestValue as Oe}from"../../hooks/use-latest-value.js";import{useTreeWalker as ge}from"../../hooks/use-tree-walker.js";import{sortByDomNode as Ce}from"../../utils/focus-management.js";import{VisuallyHidden as Re}from"../../internal/visually-hidden.js";import{objectToFormEntries as ve}from"../../utils/form.js";var ye=(n=>(n[n.Open=0]="Open",n[n.Closed=1]="Closed",n))(ye||{}),Pe=(n=>(n[n.Single=0]="Single",n[n.Multi=1]="Multi",n))(Pe||{}),Se=(n=>(n[n.Pointer=0]="Pointer",n[n.Other=1]="Other",n))(Se||{}),Ae=(i=>(i[i.OpenCombobox=0]="OpenCombobox",i[i.CloseCombobox=1]="CloseCombobox",i[i.SetDisabled=2]="SetDisabled",i[i.GoToOption=3]="GoToOption",i[i.RegisterOption=4]="RegisterOption",i[i.UnregisterOption=5]="UnregisterOption",i))(Ae||{});function Q(o,a=n=>n){let n=o.activeOptionIndex!==null?o.options[o.activeOptionIndex]:null,e=Ce(a(o.options.slice()),t=>t.dataRef.current.domRef.current),l=n?e.indexOf(n):null;return l===-1&&(l=null),{options:e,activeOptionIndex:l}}let Ie={[1](o){return o.disabled||o.comboboxState===1?o:{...o,activeOptionIndex:null,comboboxState:1}},[0](o){if(o.disabled||o.comboboxState===0)return o;let a=o.activeOptionIndex,{value:n,mode:e}=o.comboboxPropsRef.current,l=o.options.findIndex(t=>{let i=t.dataRef.current.value;return E(e,{[1]:()=>n.includes(i),[0]:()=>n===i})});return l!==-1&&(a=l),{...o,comboboxState:0,activeOptionIndex:a}},[2](o,a){return o.disabled===a.disabled?o:{...o,disabled:a.disabled}},[3](o,a){var l;if(o.disabled||o.optionsRef.current&&!o.optionsPropsRef.current.static&&o.comboboxState===1)return o;let n=Q(o);if(n.activeOptionIndex===null){let t=n.options.findIndex(i=>!i.dataRef.current.disabled);t!==-1&&(n.activeOptionIndex=t)}let e=de(a,{resolveItems:()=>n.options,resolveActiveIndex:()=>n.activeOptionIndex,resolveId:t=>t.id,resolveDisabled:t=>t.dataRef.current.disabled});return{...o,...n,activeOptionIndex:e,activationTrigger:(l=a.trigger)!=null?l:1}},[4]:(o,a)=>{let n={id:a.id,dataRef:a.dataRef},e=Q(o,t=>[...t,n]);if(o.activeOptionIndex===null){let{value:t,mode:i}=o.comboboxPropsRef.current,r=a.dataRef.current.value;E(i,{[1]:()=>t.includes(r),[0]:()=>t===r})&&(e.activeOptionIndex=e.options.indexOf(n))}let l={...o,...e,activationTrigger:1};return o.comboboxPropsRef.current.__demoMode&&o.comboboxPropsRef.current.value===void 0&&(l.activeOptionIndex=0),l},[5]:(o,a)=>{let n=Q(o,e=>{let l=e.findIndex(t=>t.id===a.id);return l!==-1&&e.splice(l,1),e});return{...o,...n,activationTrigger:1}}},Y=$(null);Y.displayName="ComboboxContext";function U(o){let a=q(Y);if(a===null){let n=new Error(`<${o} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(n,U),n}return a}let Z=$(null);Z.displayName="ComboboxActions";function W(){let o=q(Z);if(o===null){let a=new Error("ComboboxActions is missing a parent <Combobox /> component.");throw Error.captureStackTrace&&Error.captureStackTrace(a,W),a}return o}let ee=$(null);ee.displayName="ComboboxData";function G(){let o=q(ee);if(o===null){let a=new Error("ComboboxData is missing a parent <Combobox /> component.");throw Error.captureStackTrace&&Error.captureStackTrace(a,G),a}return o}function Me(o,a){return E(a.type,Ie,o,a)}let De=pe,Ee=k(function(a,n){let{name:e,value:l,onChange:t,disabled:i=!1,__demoMode:r=!1,nullable:u=!1,multiple:p=!1,...x}=a,R=L(!1),c=L({value:l,mode:p?1:0,onChange:t,nullable:u,__demoMode:r});c.current.value=l,c.current.mode=p?1:0,c.current.nullable=u;let O=L({static:!1,hold:!1}),v=L({displayValue:void 0}),S=se(Me,{comboboxState:r?0:1,comboboxPropsRef:c,optionsPropsRef:O,inputPropsRef:v,labelRef:K(),inputRef:K(),buttonRef:K(),optionsRef:K(),disabled:i,options:[],activeOptionIndex:null,activationTrigger:1}),[{comboboxState:s,options:b,activeOptionIndex:M,optionsRef:F,inputRef:y,buttonRef:_},d]=S,f=D(()=>({value:l,mode:p?1:0,get activeOptionIndex(){if(R.current&&M===null&&b.length>0){let m=b.findIndex(T=>!T.dataRef.current.disabled);if(m!==-1)return m}return M}}),[l,M,b]),g=f.activeOptionIndex;I(()=>{c.current.onChange=m=>E(f.mode,{[0](){return t(m)},[1](){let T=f.value.slice(),h=T.indexOf(m);return h===-1?T.push(m):T.splice(h,1),t(T)}})},[f,t,c,f]),I(()=>d({type:2,disabled:i}),[i]),fe([_,y,F],()=>{s===0&&d({type:1})});let H=g===null?null:b[g].dataRef.current.value,ie=D(()=>({open:s===0,disabled:i,activeIndex:g,activeOption:H}),[s,i,b,g]),w=A(()=>{var T;if(!y.current)return;let m=v.current.displayValue;typeof m=="function"?y.current.value=(T=m(l))!=null?T:"":typeof l=="string"?y.current.value=l:y.current.value=""},[l,y,v]),oe=A(m=>{let T=b.find(ue=>ue.id===m);if(!T)return;let{dataRef:h}=T;c.current.onChange(h.current.value),w()},[b,c,y]),te=A(()=>{if(g!==null){let{dataRef:m,id:T}=b[g];c.current.onChange(m.current.value),w(),d({type:3,focus:C.Specific,id:T})}},[g,b,c,y]),ae=D(()=>({selectOption:oe,selectActiveOption:te,openCombobox(){d({type:0}),R.current=!0},closeCombobox(){d({type:1}),R.current=!1},goToOption(m,T,h){return R.current=!1,m===C.Specific?d({type:3,focus:C.Specific,id:T,trigger:h}):d({type:3,focus:m,trigger:h})},registerOption(m,T){return d({type:4,id:m,dataRef:T}),()=>d({type:5,id:m})}}),[oe,te,d]);I(()=>{s===1&&w()},[w,s]),I(w,[w]);let le=n===null?{}:{ref:n};return B.createElement(Z.Provider,{value:ae},B.createElement(ee.Provider,{value:f},B.createElement(Y.Provider,{value:S},B.createElement(xe,{value:E(s,{[0]:z.Open,[1]:z.Closed})},e!=null&&l!=null&&ve({[e]:l}).map(([m,T])=>B.createElement(Re,{...be({key:m,as:"input",type:"hidden",hidden:!0,readOnly:!0,name:m,value:T})})),V({ourProps:le,theirProps:x,slot:ie,defaultTag:De,name:"Combobox"})))))}),he="input",Le=k(function(a,n){var y,_;let{value:e,onChange:l,displayValue:t,...i}=a,[r]=U("Combobox.Input"),u=G(),p=W(),x=j(r.inputRef,n),R=r.inputPropsRef,c=`headlessui-combobox-input-${N()}`,O=ne(),v=Oe(l);I(()=>{R.current.displayValue=t},[t,R]);let S=A(d=>{switch(d.key){case P.Backspace:case P.Delete:if(u.mode!==0||!r.comboboxPropsRef.current.nullable)return;let f=d.currentTarget;O.requestAnimationFrame(()=>{f.value===""&&(r.comboboxPropsRef.current.onChange(null),r.optionsRef.current&&(r.optionsRef.current.scrollTop=0),p.goToOption(C.Nothing))});break;case P.Enter:if(r.comboboxState!==0)return;if(d.preventDefault(),d.stopPropagation(),u.activeOptionIndex===null){p.closeCombobox();return}p.selectActiveOption(),u.mode===0&&p.closeCombobox();break;case P.ArrowDown:return d.preventDefault(),d.stopPropagation(),E(r.comboboxState,{[0]:()=>{p.goToOption(C.Next)},[1]:()=>{p.openCombobox(),O.nextFrame(()=>{u.value||p.goToOption(C.Next)})}});case P.ArrowUp:return d.preventDefault(),d.stopPropagation(),E(r.comboboxState,{[0]:()=>{p.goToOption(C.Previous)},[1]:()=>{p.openCombobox(),O.nextFrame(()=>{u.value||p.goToOption(C.Last)})}});case P.Home:case P.PageUp:return d.preventDefault(),d.stopPropagation(),p.goToOption(C.First);case P.End:case P.PageDown:return d.preventDefault(),d.stopPropagation(),p.goToOption(C.Last);case P.Escape:return d.preventDefault(),r.optionsRef.current&&!r.optionsPropsRef.current.static&&d.stopPropagation(),p.closeCombobox();case P.Tab:p.selectActiveOption(),p.closeCombobox();break}},[O,r,p,u]),s=A(d=>{var f;p.openCombobox(),(f=v.current)==null||f.call(v,d)},[p,v]),b=X(()=>{if(!!r.labelRef.current)return[r.labelRef.current.id].join(" ")},[r.labelRef.current]),M=D(()=>({open:r.comboboxState===0,disabled:r.disabled}),[r]),F={ref:x,id:c,role:"combobox",type:"text","aria-controls":(y=r.optionsRef.current)==null?void 0:y.id,"aria-expanded":r.disabled?void 0:r.comboboxState===0,"aria-activedescendant":u.activeOptionIndex===null||(_=r.options[u.activeOptionIndex])==null?void 0:_.id,"aria-multiselectable":u.mode===1?!0:void 0,"aria-labelledby":b,disabled:r.disabled,onKeyDown:S,onChange:s};return V({ourProps:F,theirProps:i,slot:M,defaultTag:he,name:"Combobox.Input"})}),Fe="button",_e=k(function(a,n){var S;let[e]=U("Combobox.Button"),l=G(),t=W(),i=j(e.buttonRef,n),r=`headlessui-combobox-button-${N()}`,u=ne(),p=A(s=>{switch(s.key){case P.ArrowDown:return s.preventDefault(),s.stopPropagation(),e.comboboxState===1&&(t.openCombobox(),u.nextFrame(()=>{l.value||t.goToOption(C.First)})),u.nextFrame(()=>{var b;return(b=e.inputRef.current)==null?void 0:b.focus({preventScroll:!0})});case P.ArrowUp:return s.preventDefault(),s.stopPropagation(),e.comboboxState===1&&(t.openCombobox(),u.nextFrame(()=>{l.value||t.goToOption(C.Last)})),u.nextFrame(()=>{var b;return(b=e.inputRef.current)==null?void 0:b.focus({preventScroll:!0})});case P.Escape:return s.preventDefault(),e.optionsRef.current&&!e.optionsPropsRef.current.static&&s.stopPropagation(),t.closeCombobox(),u.nextFrame(()=>{var b;return(b=e.inputRef.current)==null?void 0:b.focus({preventScroll:!0})});default:return}},[u,e,t,l]),x=A(s=>{if(ce(s.currentTarget))return s.preventDefault();e.comboboxState===0?t.closeCombobox():(s.preventDefault(),t.openCombobox()),u.nextFrame(()=>{var b;return(b=e.inputRef.current)==null?void 0:b.focus({preventScroll:!0})})},[t,u,e]),R=X(()=>{if(!!e.labelRef.current)return[e.labelRef.current.id,r].join(" ")},[e.labelRef.current,r]),c=D(()=>({open:e.comboboxState===0,disabled:e.disabled}),[e]),O=a,v={ref:i,id:r,type:Te(a,e.buttonRef),tabIndex:-1,"aria-haspopup":!0,"aria-controls":(S=e.optionsRef.current)==null?void 0:S.id,"aria-expanded":e.disabled?void 0:e.comboboxState===0,"aria-labelledby":R,disabled:e.disabled,onClick:x,onKeyDown:p};return V({ourProps:v,theirProps:O,slot:c,defaultTag:Fe,name:"Combobox.Button"})}),we="label",ke=k(function(a,n){let[e]=U("Combobox.Label"),l=`headlessui-combobox-label-${N()}`,t=j(e.labelRef,n),i=A(()=>{var x;return(x=e.inputRef.current)==null?void 0:x.focus({preventScroll:!0})},[e.inputRef]),r=D(()=>({open:e.comboboxState===0,disabled:e.disabled}),[e]);return V({ourProps:{ref:t,id:l,onClick:i},theirProps:a,slot:r,defaultTag:we,name:"Combobox.Label"})}),Ve="ul",Ue=re.RenderStrategy|re.Static,Be=k(function(a,n){var S;let{hold:e=!1,...l}=a,[t]=U("Combobox.Options"),i=G(),{optionsPropsRef:r}=t,u=j(t.optionsRef,n),p=`headlessui-combobox-options-${N()}`,x=me(),R=(()=>x!==null?x===z.Open:t.comboboxState===0)();I(()=>{var s;r.current.static=(s=a.static)!=null?s:!1},[r,a.static]),I(()=>{r.current.hold=e},[e,r]),ge({container:t.optionsRef.current,enabled:t.comboboxState===0,accept(s){return s.getAttribute("role")==="option"?NodeFilter.FILTER_REJECT:s.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(s){s.setAttribute("role","none")}});let c=X(()=>{var s,b,M;return(M=(s=t.labelRef.current)==null?void 0:s.id)!=null?M:(b=t.buttonRef.current)==null?void 0:b.id},[t.labelRef.current,t.buttonRef.current]),O=D(()=>({open:t.comboboxState===0}),[t]),v={"aria-activedescendant":i.activeOptionIndex===null||(S=t.options[i.activeOptionIndex])==null?void 0:S.id,"aria-labelledby":c,role:"listbox",id:p,ref:u};return V({ourProps:v,theirProps:l,slot:O,defaultTag:Ve,features:Ue,visible:R,name:"Combobox.Options"})}),Ne="li",je=k(function(a,n){let{disabled:e=!1,value:l,...t}=a,[i]=U("Combobox.Option"),r=G(),u=W(),p=`headlessui-combobox-option-${N()}`,x=r.activeOptionIndex!==null?i.options[r.activeOptionIndex].id===p:!1,R=E(r.mode,{[1]:()=>r.value.includes(l),[0]:()=>r.value===l}),c=L(null),O=L({disabled:e,value:l,domRef:c}),v=j(n,c);I(()=>{O.current.disabled=e},[O,e]),I(()=>{O.current.value=l},[O,l]),I(()=>{var f,g;O.current.textValue=(g=(f=c.current)==null?void 0:f.textContent)==null?void 0:g.toLowerCase()},[O,c]);let S=A(()=>u.selectOption(p),[u,p]);I(()=>u.registerOption(p,O),[O,p]);let s=L(!i.comboboxPropsRef.current.__demoMode);I(()=>{if(!i.comboboxPropsRef.current.__demoMode)return;let f=J();return f.requestAnimationFrame(()=>{s.current=!0}),f.dispose},[]),I(()=>{if(i.comboboxState!==0||!x||!s.current||i.activationTrigger===0)return;let f=J();return f.requestAnimationFrame(()=>{var g,H;(H=(g=c.current)==null?void 0:g.scrollIntoView)==null||H.call(g,{block:"nearest"})}),f.dispose},[c,x,i.comboboxState,i.activationTrigger,r.activeOptionIndex]);let b=A(f=>{if(e)return f.preventDefault();S(),r.mode===0&&(u.closeCombobox(),J().nextFrame(()=>{var g;return(g=i.inputRef.current)==null?void 0:g.focus({preventScroll:!0})}))},[u,i.inputRef,e,S]),M=A(()=>{if(e)return u.goToOption(C.Nothing);u.goToOption(C.Specific,p)},[e,p,u]),F=A(()=>{e||x||u.goToOption(C.Specific,p,0)},[e,x,p,u]),y=A(()=>{e||!x||i.optionsPropsRef.current.hold||u.goToOption(C.Nothing)},[e,x,u,i.comboboxState,i.comboboxPropsRef]),_=D(()=>({active:x,selected:R,disabled:e}),[x,R,e]);return V({ourProps:{id:p,ref:v,role:"option",tabIndex:e===!0?void 0:-1,"aria-disabled":e===!0?!0:void 0,"aria-selected":R===!0?!0:void 0,disabled:void 0,onClick:b,onFocus:M,onPointerMove:F,onMouseMove:F,onPointerLeave:y,onMouseLeave:y},theirProps:t,slot:_,defaultTag:Ne,name:"Combobox.Option"})}),go=Object.assign(Ee,{Input:Le,Button:_e,Label:ke,Options:Be,Option:je});export{go as Combobox};
