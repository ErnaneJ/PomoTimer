import l,{Fragment as G,createContext as B,useContext as _,useEffect as v,useMemo as W,useRef as C,useState as U}from"react";import{Features as ue,forwardRefWithAs as q,render as z,RenderStrategy as T}from"../../utils/render.js";import{OpenClosedProvider as de,State as V,useOpenClosed as J}from"../../internal/open-closed.js";import{match as I}from"../../utils/match.js";import{microTask as fe}from"../../utils/micro-task.js";import{useId as Te}from"../../hooks/use-id.js";import{useIsMounted as pe}from"../../hooks/use-is-mounted.js";import{useIsoMorphicEffect as ce}from"../../hooks/use-iso-morphic-effect.js";import{useLatestValue as b}from"../../hooks/use-latest-value.js";import{useServerHandoffComplete as K}from"../../hooks/use-server-handoff-complete.js";import{useSyncRefs as Q}from"../../hooks/use-sync-refs.js";import{useTransition as me}from"../../hooks/use-transition.js";function c(e=""){return e.split(" ").filter(r=>r.trim().length>1)}let N=B(null);N.displayName="TransitionContext";var he=(t=>(t.Visible="visible",t.Hidden="hidden",t))(he||{});function ge(){let e=_(N);if(e===null)throw new Error("A <Transition.Child /> is used but it is missing a parent <Transition /> or <Transition.Root />.");return e}function ve(){let e=_(R);if(e===null)throw new Error("A <Transition.Child /> is used but it is missing a parent <Transition /> or <Transition.Root />.");return e}let R=B(null);R.displayName="NestingContext";function F(e){return"children"in e?F(e.children):e.current.filter(({state:r})=>r==="visible").length>0}function X(e){let r=b(e),t=C([]),n=pe(),u=b((s,o=T.Hidden)=>{let i=t.current.findIndex(({id:d})=>d===s);i!==-1&&(I(o,{[T.Unmount](){t.current.splice(i,1)},[T.Hidden](){t.current[i].state="hidden"}}),fe(()=>{var d;!F(t)&&n.current&&((d=r.current)==null||d.call(r))}))}),m=b(s=>{let o=t.current.find(({id:i})=>i===s);return o?o.state!=="visible"&&(o.state="visible"):t.current.push({id:s,state:"visible"}),()=>u.current(s,T.Unmount)});return W(()=>({children:t,register:m,unregister:u}),[m,u,t])}function Ce(){}let be=["beforeEnter","afterEnter","beforeLeave","afterLeave"];function Y(e){var t;let r={};for(let n of be)r[n]=(t=e[n])!=null?t:Ce;return r}function Se(e){let r=C(Y(e));return v(()=>{r.current=Y(e)},[e]),r}let xe="div",Z=ue.RenderStrategy,$=q(function(r,t){let{beforeEnter:n,afterEnter:u,beforeLeave:m,afterLeave:s,enter:o,enterFrom:i,enterTo:d,entered:S,leave:x,leaveFrom:E,leaveTo:L,...p}=r,h=C(null),y=Q(h,t),[f,A]=U("visible"),D=p.unmount?T.Unmount:T.Hidden,{show:g,appear:ee,initial:te}=ge(),{register:P,unregister:H}=ve(),O=C(null),a=Te(),re=C(!1),k=X(()=>{re.current||(A("hidden"),H.current(a))});v(()=>{if(!!a)return P.current(a)},[P,a]),v(()=>{if(D===T.Hidden&&!!a){if(g&&f!=="visible"){A("visible");return}I(f,{["hidden"]:()=>H.current(a),["visible"]:()=>P.current(a)})}},[f,a,P,H,g,D]);let ne=b({enter:c(o),enterFrom:c(i),enterTo:c(d),entered:c(S),leave:c(x),leaveFrom:c(E),leaveTo:c(L)}),ie=Se({beforeEnter:n,afterEnter:u,beforeLeave:m,afterLeave:s}),w=K();v(()=>{if(w&&f==="visible"&&h.current===null)throw new Error("Did you forget to passthrough the `ref` to the actual DOM node?")},[h,f,w]);let M=te&&!ee,se=(()=>!w||M||O.current===g?"idle":g?"enter":"leave")();me({container:h,classes:ne,events:ie,direction:se,onStart:b(()=>{}),onStop:b(le=>{le==="leave"&&!F(k)&&(A("hidden"),H.current(a))})}),v(()=>{!M||(D===T.Hidden?O.current=null:O.current=g)},[g,M,f]);let oe=p,ae={ref:y};return l.createElement(R.Provider,{value:k},l.createElement(de,{value:I(f,{["visible"]:V.Open,["hidden"]:V.Closed})},z({ourProps:ae,theirProps:oe,defaultTag:xe,features:Z,visible:f==="visible",name:"Transition.Child"})))}),j=q(function(r,t){let{show:n,appear:u=!1,unmount:m,...s}=r,o=Q(t);K();let i=J();if(n===void 0&&i!==null&&(n=I(i,{[V.Open]:!0,[V.Closed]:!1})),![!0,!1].includes(n))throw new Error("A <Transition /> is used but it is missing a `show={true | false}` prop.");let[d,S]=U(n?"visible":"hidden"),x=X(()=>{S("hidden")}),[E,L]=U(!0),p=C([n]);ce(()=>{E!==!1&&p.current[p.current.length-1]!==n&&(p.current.push(n),L(!1))},[p,n]);let h=W(()=>({show:n,appear:u,initial:E}),[n,u,E]);v(()=>{n?S("visible"):F(x)||S("hidden")},[n,x]);let y={unmount:m};return l.createElement(R.Provider,{value:x},l.createElement(N.Provider,{value:h},z({ourProps:{...y,as:G,children:l.createElement($,{ref:o,...y,...s})},theirProps:{},defaultTag:G,features:Z,visible:d==="visible",name:"Transition"})))});function Ee(e){let r=_(N)!==null,t=J()!==null;return l.createElement(l.Fragment,null,!r&&t?l.createElement(j,{...e}):l.createElement($,{...e}))}let Ge=Object.assign(j,{Child:Ee,Root:j});export{Ge as Transition};
